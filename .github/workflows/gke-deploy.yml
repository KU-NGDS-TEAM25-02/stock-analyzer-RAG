name: CI/CD to GKE with Workload Identity Federation

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_REGION: ${{ secrets.GKE_REGION }}
  DEPLOYMENT_NAME: stock-analyzer-deployment
  CONTAINER_NAME: stock-analyzer-container
  IMAGE_PATH: ${{ secrets.ARTIFACT_REGISTRY_REPO }}/stock-analyzer:${{ github.sha }}

jobs:
  # -------------------------
  # CI: ë¹Œë“œ ë° ì´ë¯¸ì§€ í‘¸ì‹œ (ìˆ˜ì •ë¨)
  # -------------------------
  build-and-push:
    name: Build and Push to Artifact Registry
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # (í•„ìˆ˜) WIF ì¸ì¦ìš©

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. WIF ì¸ì¦ + 'ìˆœìˆ˜ ì•¡ì„¸ìŠ¤ í† í°' ì¶œë ¥
      # 'id'ë¥¼ ë¶€ì—¬í•˜ê³  'token_format'ì„ ì¶”ê°€
      - name: Authenticate to Google Cloud
        id: auth # 'steps.auth.outputs'ë¡œ ì°¸ì¡°í•˜ê¸° ìœ„í•´ ID ë¶€ì—¬
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: "access_token" # ğŸ‘ˆ (í•µì‹¬) JSON íŒŒì¼ ëŒ€ì‹  ìˆœìˆ˜ í† í° ìƒì„±

      # 2. gcloud í—¬í¼ ëŒ€ì‹  docker/login-actionìœ¼ë¡œ ì§ì ‘ ë¡œê·¸ì¸
      - name: Login to Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ARTIFACT_REGISTRY_DOMAIN }} # ìƒˆë¡œ ì¶”ê°€í•œ Secret (ì˜ˆ: asia-northeast3-docker.pkg.dev)
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }} # 1ë²ˆ ìŠ¤í…ì—ì„œ ìƒì„±í•œ ìˆœìˆ˜ í† í°

      # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: docker build -t $IMAGE_PATH .

      # 4. Docker ì´ë¯¸ì§€ í‘¸ì‹œ
      - name: Push Docker image
        run: docker push $IMAGE_PATH

  # -------------------------
  # CD: GKEì— ë°°í¬
  # -------------------------
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: 'read'
      id-token: 'write' #(í•„ìˆ˜) WIF ì¸ì¦ìš©

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # (ì°¸ê³ ) deploy ì¡ì˜ ì¸ì¦ì€ GKE(gcloud/kubectl)ë¥¼ ìœ„í•œ ê²ƒì´ë¯€ë¡œ
      # 'token_format'ì´ í•„ìš” ì—†ìœ¼ë©°, ê¸°ì¡´ ë°©ì‹ì´ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•©ë‹ˆë‹¤.
      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Get GKE cluster credentials
        uses: 'google-github-actions/get-gke-credentials@v2'
        with:
          cluster_name: $GKE_CLUSTER
          location: $GKE_REGION

      - name: Deploy to GKE
        run: |
          kubectl set image deployment/$DEPLOYMENT_NAME $CONTAINER_NAME=$IMAGE_PATH \
            --record