name: CI/CD to GKE with Workload Identity Federation

# 1. íŠ¸ë¦¬ê±° ì¡°ê±´: 'main' ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œ(push)ë  ë•Œ ì‹¤í–‰
on:
  push:
    branches: [ "main" ]

# 2. ì›Œí¬í”Œë¡œì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜ ì •ì˜
# GitHub Secretsë¥¼ ì°¸ì¡°
env:
  # GCP ì •ë³´
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_REGION: ${{ secrets.GKE_REGION }}
  
  # GKE ë°°í¬ ì •ë³´
  DEPLOYMENT_NAME: stock-analyzer-deployment # GKE Deployment ì´ë¦„
  CONTAINER_NAME: stock-analyzer-container   # Deploymentì˜ ì»¨í…Œì´ë„ˆ ì´ë¦„

  # Artifact Registry (AR) ì •ë³´
  # GITHUB_SHAëŠ” í˜„ì¬ ì»¤ë°‹ì˜ ê³ ìœ  IDë¥¼ ì˜ë¯¸ (ì´ë¯¸ì§€ íƒœê·¸ë¡œ ì‚¬ìš©)
  IMAGE_PATH: ${{ secrets.ARTIFACT_REGISTRY_REPO }}/stock-analyzer:${{ github.sha }}

jobs:
  # -------------------------
  # CI: ë¹Œë“œ ë° ì´ë¯¸ì§€ í‘¸ì‹œ
  # -------------------------
  build-and-push:
    name: Build and Push to Artifact Registry
    runs-on: ubuntu-latest

    # 3. (í•„ìˆ˜) WIFë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ 'id-token: write' ê¶Œí•œì´ í•„ìš”
    permissions:
      contents: 'read'
      id-token: 'write' # ğŸ‘ˆ GitHubì´ Googleì— OIDC í† í°ì„ ë³´ë‚¼ ìˆ˜ ìˆê²Œ í—ˆìš©

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 4. (ì¸ì¦) WIFë¥¼ í†µí•´ Google Cloudì— ì¸ì¦
    - name: Authenticate to Google Cloud
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    # 5. (Docker ì„¤ì •) gcloud CLIë¥¼ ì‚¬ìš©í•´ Artifact Registryì— Docker ì¸ì¦
    # ARTIFACT_REGISTRY_REPOì—ì„œ ë¦¬ì „ ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì˜ˆ: asia-northeast3)
    - name: Configure Docker for Artifact Registry
      run: |
        HOST=$(echo ${{ secrets.ARTIFACT_REGISTRY_REPO }} | cut -d'/' -f1)
        gcloud auth configure-docker $HOST

    # 6. (ë¹Œë“œ) Dockerfileì„ ì‚¬ìš©í•´ Spring Boot ì•± ë¹Œë“œ
    - name: Build Docker image
      run: docker build -t $IMAGE_PATH .

    # 7. (í‘¸ì‹œ) ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ Artifact Registryë¡œ í‘¸ì‹œ
    - name: Push Docker image
      run:
        gcloud auth login
        docker push $IMAGE_PATH

  # -------------------------
  # CD: GKEì— ë°°í¬
  # -------------------------
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    # 'build-and-push' ì¡ì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰ë¨
    needs: build-and-push

    # (í•„ìˆ˜) WIF ì¸ì¦ ê¶Œí•œ
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 1. (ì¸ì¦) Google Cloudì— ì¸ì¦ (ëª¨ë“  'job'ì€ ë…ë¦½ëœ í™˜ê²½ì´ë¯€ë¡œ ë‹¤ì‹œ ì¸ì¦)
    - name: Authenticate to Google Cloud
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    # 2. (GKE ì—°ê²°) gcloud CLIë¥¼ ì‚¬ìš©í•´ GKE í´ëŸ¬ìŠ¤í„°ì— kubectl ì—°ê²°
    - name: Get GKE cluster credentials
      uses: 'google-github-actions/get-gke-credentials@v2'
      with:
        cluster_name: $GKE_CLUSTER
        location: $GKE_REGION

    # 3. (ë°°í¬) GKEì— ë°°í¬ëœ Deploymentì˜ ì´ë¯¸ì§€ë¥¼ ìƒˆ ì´ë¯¸ì§€($IMAGE_PATH)ë¡œ êµì²´
    # 'kubectl set image'ëŠ” ë¬´ì¤‘ë‹¨ ë¡¤ë§ ì—…ë°ì´íŠ¸ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.
    - name: Deploy to GKE
      run: |
        kubectl set image deployment/$DEPLOYMENT_NAME $CONTAINER_NAME=$IMAGE_PATH \
          --record
